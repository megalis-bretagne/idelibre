TODO 248-Ajout case au mail de validation

- Ajout au template de mail une variable #presence#
    - Cette variable sera un lien vers une page idelibre qui contiendra le form de confirmation de presence

- Faire le front du form
    - Le form doit contenir les élements suivants :
     . Presence : oui/non
     . Mandataire : xxx
     . convocationId (caché)
     . userId (caché et issus de convocationId)
     . sittingId (caché et issus de convocationId)

- Traitement du form

- Créer l'entité qui contiendra la réponse: ConfirmAttendance

- [ Feature ] Affichage des réponse ds le back ou envoi par mail a la collectivité, les réponses






TODO faire une validation jsonb !!!! #[jsonComelus()] par exemple !
#create user idelibre;
#alter user idelibre with login superuser createdb encrypted password 'idelibre';


Create theme ROOT soit à la creation de la structure soit le creer lorss du premier enregistrement s'il n'existe pas



Faire une deifrerence entre la denomination remve et delete.
le delete faisant unn remove + flush



CHANGER LE USERINTERFACE du l'utilisateur pour avoir des methodes en plus !!

configuration snappy

$pdf = $snappy->getOutputFromHtml($html, array(
    'orientation' => 'landscape',
    'enable-javascript' => true,
    'javascript-delay' => 1000,
    'no-stop-slow-scripts' => true,
    'no-background' => false,
    'lowquality' => false,
    'page-height' => 124 * 3,
    'page-width'  => 192 * 3,
    'encoding' => 'utf-8',
    'images' => true,
    'cookie' => array(),
    'dpi' => 300,
    'enable-external-links' => true,
    'enable-internal-links' => true


ANOUK
-----------------------
Supprimer
Suppression de la séance
dans le modal preciser le nom de l'object nom se la seance par exemple

selectOrButton s'il y a peu d'element (a voir)


Regarder les data transformers pour eviter cela dans les forms. Faire plutot un type custom !
$builder->add('structure', HiddenType::class, [
            'data' => $options['structure'],
        ]);

        $builder->get("structure")->addModelTransformer(new CallbackTransformer(
            fn () =>  '',
            fn () =>  $options['structure']
        ));




Tous les path dans la bd devrait etre a partir d'un chemin donnée. Conseil Epommateau !


Creer le cache pour postgres (bénéfique à tous)

pg_dump --dbname=postgresql://idelibre:idelibre@127.0.0.1:5432/idelibre_docker --schema-only --file "/tmp/docker2.sql"

bin/console doctrine:database:create --env test
bin/console doctrine:migration:migrate --env test
bin/console doctrine:fixture:load --env test


SET CONSTRAINTS ALL DEFERRED

SET CONSTRAINTS ALL IMMEDIATE


FIXER les ID des roles (cela sera bien plus simple !)

FAIRE un DTO pour le typetype
Comme ça on aun object qui as les 3 propriétés : associatedActors, associatedGuests et associatedAdministratives



Peut etre mettre des tooltips o des popever partout par exemple sur profile la liste des profiles avec explication


https://idelibre-4.recette.libriciel.net


pour les enums
https://github.com/myclabs/php-enum
sinon un bete splenum ferait peut etre l'affaire ?


FAUT Une TYPe peut avoir plusisuer email template.
Par exemple un pour la convocation et un pour l'invitation !!!!
Ou alors on decide qu el emessage d'invitaiton est générique à tous les type des séances.
Possibilité et surment plus simple à gérer (voir ce que font les collectivité sur nos instance !)


/**
     * @ORM\OneToOne(targetEntity=EmailTemplate::class, mappedBy="type")
     */
    private $emailTemplate;





Faire un type custom pour le suffixType et eviter ça
$builder->get('username')->addModelTransformer(new CallbackTransformer(
            fn ($username) => preg_replace('/@.*/', '', $username),
            fn ($username) => $username . '@.' . $this->getStructureSuffix($options['structure'])
        ));
et d'avoir a detailler le form




TODO enlever la category de convocation , on peut faire le distingo avec l'user associé



Avec le css genere par webpack il va falloir gerer le pb de ça dans template/generate
<link rel="stylesheet" href="{{ absolute_url(asset('assets/bootstrap/css/il-bootstrap-4.css')) }}">




creer un fakeClientnotifier implement ClientNotifier interface . logs in test



modification ratachement du theme  -> A voir


gerer les presenece  D'abord les elus puis separateur  puis administratifs  -> Pas mauvaise idée mais pas le temps la !


bouton ouvrir nouelle onglet client elus


WARNING VERIFIER Migration sequence !!!!!! semble ne fonctionner qu'ave un create sequence seul dans sa migration !
C'et la migration d'apres qui 'lenlever.'
Si on le fait avec une annotion il le prend pour la primary key ce con !
//CREATE SEQUENCE IF NOT EXISTS party_legacy_seq INCREMENT BY 1 MINVALUE 1 START 1;  à cahque start comme ça c'et reglé !


IMPORT CSV : L'import est lent Cela est du à l'ecodage des passwords !

Peut Etre faire un preference pour les strcutremanager et un autre pour les user normaux ?


5) Gpe politique : bouton "tous les élus" | Faire disparaître l'élu quand sélectionné ? (+ message d'erreur à la création) A voir n'existe pas aujourd'hui
9) Doc zip : si mm nom annexe et projet >> l'annexe n'apparait pas dans le zip  (Par construction du doc. si on gare les noms d'origine ça fait forcement ça)
1) Super admin : pas de vue sur les infos de la coll quand se connecte à la coll  (Vu que tu peux les avoir via le menu de structure ya pas trop d'interet)
13) Com'Elus : Mettre la date de la séance dans le texte d'accompagnement (A VOIR plus tard)
14) Com'Elus : Voir le nom de la structure dans le connecteur   (Comelus ne le retourne pas pour le moment à faire)


WARNING !
update or delete on table "user" violates foreign key constraint "fk_2e443ef2f675f31b" on table "annotation"




Marque blanch : name, editor, css, images, version

TODO functionnalité blacklisted n'est pas convocable
TODO champlibre ?



 ->setCategory(EmailTemplate::CATEGORY_RESET_PASSWORD)
            ->setContent(DefaultTemplate::FORGET_PASSWORD);



BUG du choix du groupe de partage quand nouvellemnt créé pas pris en compte

Choix comelus proposer alors que le connecteur n'est pas activer generalement















TRIM de tous les nom / prenom dans la bdd !!!!!!


secretaire : creer une seance erreur 500



supprime utilisateur avec compte admin

 fpm-idelibre      | {"message":"Uncaught PHP Exception Doctrine\\DBAL\\Exception\\ForeignKeyConstraintViolationException: \"An exception occurred while executing 'DELETE FROM \"user\" WHERE id = ?' with params [\"56d44844-5e54-492f-bab4-2486c18e9eb7\"]:\n\nSQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table \"user\" violates foreign key constraint \"fk_2fb3d0eee1cfe6f5\" on table \"project\"\nDETAIL:  Key (id)=(56d44844-5e54-492f-bab4-2486c18e9eb7) is still referenced from table \"project\".\" at /app/vendor/doctrine/dbal/lib/Doctrine/DBAL/Driver/AbstractPostgreSQLDriver.php line 67","context":{"exception":{"class":"Doctrine\\DBAL\\Exception\\ForeignKeyConstraintViolationException","message":"An exception occurred while executing 'DELETE FROM \"user\" WHERE id = ?' with params [\"56d44844-5e54-492f-bab4-2486c18e9eb7\"]:\n\nSQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table \"user\" violates foreign key constraint \"fk_2fb3d0eee1cfe6f5\" on table \"project\"\nDETAIL:  Key (id)=(56d44844-5e54-492f-bab4-2486c18e9eb7) is still referenced from table \"project\".","code":0,"file":"/app/vendor/doctrine/dbal/lib/Doctrine/DBAL/Driver/AbstractPostgreSQLDriver.php:67","previous":{"class":"Doctrine\\DBAL\\Driver\\PDO\\Exception","message":"SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table \"user\" violates foreign key constraint \"fk_2fb3d0eee1cfe6f5\" on table \"project\"\nDETAIL:  Key (id)=(56d44844-5e54-492f-bab4-2486c18e9eb7) is still referenced from table \"project\".","code":23503,"file":"/app/vendor/doctrine/dbal/lib/Doctrine/DBAL/Driver/PDO/Exception.php:18","previous":{"class":"PDOException","message":"SQLSTATE[23503]: Foreign key violation: 7 ERROR:  update or delete on table \"user\" violates foreign key constraint \"fk_2fb3d0eee1cfe6f5\" on table \"project\"\nDETAIL:  Key (id)=(56d44844-5e54-492f-bab4-2486c18e9eb7) is still referenced from table \"project\".","code":23503,"file":"/app/vendor/doctrine/dbal/lib/Doctrine/DBAL/Driver/PDOStatement.php:112"}}}},"level":500,"level_name":"CRITICAL","channel":"request","datetime":"2021-08-24T14:32:33.194940+00:00","extra":{}}
fpm-idelibre      | {"message":"Failed to save key \"Symfony%5CComponent%5CHttpKernel%5CController%5CErrorController\" of type array: fopen(/app/var/cache/prod/pools/GXnXgNGobZ/0bbd6742046e): failed to open stream: Permission denied","context":{"key":"Symfony%5CComponent%5CHttpKernel%5CController%5CErrorController","exception":{"class":"ErrorException","message":"fopen(/app/var/cache/prod/pools/GXnXgNGobZ/0bbd6742046e): failed to open stream: Permission denied","code":0,"file":"/app/vendor/symfony/cache/Traits/FilesystemCommonTrait.php:99"},"cache-adapter":"Symfony\\Component\\Cache\\Adapter\\PhpFilesAdapter"},"level":300,"level_name":"WARNING","channel":"cache","datetime":"2021-08-24T14:32:33.200477+00:00","extra":{}}





eenlever l'extension @ dans le type de seance dans la liste







RENOMER CALENDAR en REMINDER pour le model


                  id                  |             structure_id             |          name          | token
--------------------------------------+--------------------------------------+------------------------+-------
 3f79ab1b-3727-4f6d-a839-d7b3d3a6c46f | 3f79ab1b-3727-4f6d-a839-d7b3d3a6c44a | api tructure libriciel | 1234
(1 row)



insert into api_user(id, structure_id, name, token, api_role_id)
  values('3f79ab1b-3727-4f6d-a839-d7b3d3a6c46f', '3f79ab1b-3727-4f6d-a839-d7b3d3a6c44a', 'libriciel api', '1234', 'ba98ff85-a720-4ca6-a877-c91de3ac4cf4');


TODO EMPECHER d'utiliser des données interdite exemple. associer un utilisateur d'une autre structure idem pour un party ou mettre un droit trop haut !

EMPECHER DE MODIFIER UN ELEMENT QUI N'EST PAS DANS LA STRUCTURE DE L'URL !





public function configureOptions(OptionsResolver $resolver)
    {
        $resolver->setDefaults([
            'class_name' => null
        ]);
    }




MIGRATION 4.1
-> ajouter au vhost dans le location php tout en bas (on pourrait essayer de le faire au start si on est chaud !)
fastcgi_param  HTTP_HOST URL;


Demarer le container fpm-idelibre
//docker-compose -f docker-compose-dev.yml up -d fpm-idelibre
// mieux encore dans l'netry point
Si pas doctrine_migration_versions table alors
bin/console doctrine:migrations:sync-metadata-storage

INSERT INTO doctrine_migration_versions (version, executed_at, execution_time) SELECT concat('DoctrineMigrations\Version', version), executed_at, 1 FROM migration_versions;



Ecrire test pour ics
